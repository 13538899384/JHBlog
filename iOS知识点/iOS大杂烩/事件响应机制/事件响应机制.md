## 事件响应机制 



### iOS中的事件

iOS 的事件可以分为三种

- Touch Events(触摸事件)
- Motion Events(运动事件，比如重力感应和摇一摇等)
- Remote Events(远程事件，比如用耳机上得按键来控制手机)

我们主要是研究`Touch Events(触摸事件)`，Touch Events事件的整个过程可以分为 传递和响应 2 个阶段，

- 传递： 是当我们触摸屏幕时，为我们找出最适合的 View，
- 响应： 当我们找出最适合的 View 后，此时只是找到了最合适的 View，但未必 此 View 可以响应此事件，所以需要继续找出能响应此事件的 View


### 传递过程


每当手指接触屏幕，操作系统会把事件传递给当前的 `App`， 在 `UIApplication`接收到手指的事件之后，就会去调用`UIWindow的hitTest:withEvent:`，看看当前点击的点是不是在window内，如果是则继续依次调用其 `subView`的`hitTest:withEvent:`方法，直到找到最后需要的view。调用结束并且`hit-test view`确定之后，便可以确定最合适的 `View`。


![传递过程](https://github.com/SunshineBrother/JHBlog/blob/master/iOS知识点/iOS大杂烩/事件响应机制/传递过程.png)

![传递过程1](https://github.com/SunshineBrother/JHBlog/blob/master/iOS知识点/iOS大杂烩/事件响应机制/传递过程1.png)

![传递过程2](https://github.com/SunshineBrother/JHBlog/blob/master/iOS知识点/iOS大杂烩/事件响应机制/传递过程2.png)

**应用如何找到最合适的控件来处理事件？**
- 1.首先判断主窗口（keyWindow）自己是否能接受触摸事件
- 2.判断触摸点是否在自己身上
- 3.子控件数组中从后往前遍历子控件，重复前面的两个步骤（所谓从后往前遍历子控件，就是首先查找子控件数组中最后一个元素，然后执行1、2步骤）
- 4.view，比如叫做fitView，那么会把这个事件交给这个fitView，再遍历这个fitView的子控件，直至没有更合适的view为止。
- 5.如果没有符合条件的子控件，那么就认为自己最合适处理这个事件，也就是自己是最合适的view。

 
 UIView不能接收触摸事件的三种情况：
 
- 不允许交互：userInteractionEnabled = NO
- 隐藏：如果把父控件隐藏，那么子控件也会隐藏，隐藏的控件不能接受事件
- 透明度：如果设置一个控件的透明度<0.01，会直接影响子控件的透明度。alpha：0.0~0.01为透明
 

下面是 `- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event` 方法的内部实现

```
- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event
{
if (self.hidden || !self.userInteractionEnabled || self.alpha < 0.01 || ![self pointInside:point withEvent:event] || ![self _isAnimatedUserInteractionEnabled]) {
return nil;
} else {
for (UIView *subview in [self.subviews reverseObjectEnumerator]) {
UIView *hitView = [subview hitTest:[subview convertPoint:point fromView:self] withEvent:event];
if (hitView) {
return hitView;
}
}
return self;
}
}
```

**hitTest：withEvent：方法**

- 什么时候调用？
    - 只要事件一传递给一个控件,这个控件就会调用他自己的hitTest：withEvent：方法
- 作用 
    - 寻找并返回最合适的view(能够响应事件的那个最合适的view)














[浅谈 iOS 事件的传递和响应过程](https://liangdahong.com/2018/06/08/2018/浅谈-iOS-事件的传递和响应过程/)

[史上最详细的iOS之事件的传递和响应机制-原理篇](https://www.jianshu.com/p/2e074db792ba)


[史上最详细的iOS之事件的传递和响应机制-实践篇](https://www.jianshu.com/p/3e53d4d5f293)
